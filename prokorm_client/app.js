!function(){"use strict";angular.module("auth",[]),angular.module("feed",[]),angular.module("ration",[]),angular.module("profile",[]),angular.module("catalog",[]),angular.module("info",[]),angular.module("help",[]),angular.module("admin",[]),angular.module("prokorm",["ngResource","ui.router","ngMaterial","ngMdIcons","catalog","profile","feed","ration","auth","help","info","admin"]),angular.module("prokorm").constant("_",window._),angular.module("prokorm").config(["$mdDateLocaleProvider",function($mdDateLocaleProvider){$mdDateLocaleProvider.formatDate=function(date){return moment(date).format("DD-MM-YYYY")}}]),angular.module("prokorm").config(["$httpProvider",function($httpProvider){var dialog;function isAPIrequest(url){return/^\/?api\//.test(url)}$httpProvider.defaults.headers.get||($httpProvider.defaults.headers.get={}),$httpProvider.defaults.headers.get["If-Modified-Since"]="Mon, 26 Jul 1997 05:00:00 GMT",$httpProvider.defaults.headers.get["Cache-Control"]="no-cache",$httpProvider.defaults.headers.get.Pragma="no-cache",$httpProvider.interceptors.push(function($q,$injector){return{request:function(config){return config},requestError:function(rejection){return $q.reject(rejection)},response:function(response){return isAPIrequest(response.config.url)?response.data:response},responseError:function(rejection){return 401===rejection.status&&$injector.get("$state").transitionTo("login"),isAPIrequest(rejection.config.url)?(dialog=dialog||$injector.get("$mdDialog"),401!==rejection.status&&rejection.data.message&&dialog.show(dialog.alert().clickOutsideToClose(!1).title("Ошибка").textContent(rejection.data.message).ok("Закрыть")),$q.reject(rejection.data)):$q.reject(rejection)}}});var regexIso8601=/^(\d{4}\-\d\d\-\d\d([tT][\d:\.]*)?)([zZ]|([+\-])(\d\d):?(\d\d))?$/;$httpProvider.defaults.transformResponse.push(function(responseData){return function convertDateStringsToDates(input){if("object"!=typeof input)return input;for(var key in input)if(input.hasOwnProperty(key)){var match,value=input[key];if("string"==typeof value&&(match=value.match(regexIso8601))){var milliseconds=Date.parse(match[0]);isNaN(milliseconds)||(input[key]=new Date(milliseconds))}else"object"==typeof value&&convertDateStringsToDates(value)}}(responseData),responseData})}])}(),function(){"use strict";angular.module("prokorm").config(function($stateProvider,$urlRouterProvider){$stateProvider.state("eula",{url:"/eula",templateUrl:"app/public/eula.html"}).state("conditions",{url:"/conditions",templateUrl:"app/public/conditions.html"}).state("public",{url:"",templateUrl:"app/public/public.html",controller:"PublicController",controllerAs:"public"}).state("public.list",{url:"/list",templateUrl:"app/feed/list/feedDemo.html",controller:"FeedDemoController",controllerAs:"feed"}).state("public.view",{url:"/view",templateUrl:"app/feed/view/feedView.html",controller:"FeedViewDemoController",controllerAs:"feedView"}).state("public.diff",{url:"/diff",templateUrl:"app/feed/diff/diff.html",controller:"DiffDemoController",controllerAs:"diff"}).state("public.average",{url:"/average",templateUrl:"app/feed/average/average.html",controller:"AverageDemoController",controllerAs:"average"}).state("public.sum",{url:"/sum",templateUrl:"app/feed/sum/sum.html",controller:"SumDemoController",controllerAs:"sum"}).state("public.planning",{url:"/planning",templateUrl:"app/feed/planning/planning.html",controller:"PlanningDemoController",controllerAs:"planning"}).state("public.rating",{url:"/rating",templateUrl:"app/feed/rating/ratingInstance.html",controller:"RatingDemoController",controllerAs:"rating"}).state("public.charts",{url:"/charts",templateUrl:"app/feed/charts/charts.html",controller:"ChartsDemoController",controllerAs:"charts"}).state("sano",{url:"/sano",templateUrl:"app/sano/sano.html",controller:"SanoController",controllerAs:"sano"}).state("tenant",{url:"/:id",templateUrl:"app/home/home.html",controller:"HomeController",controllerAs:"home",abstract:!0,params:{id:void 0}})})}(),angular.module("prokorm").constant("version","0.0.107"),function(){"use strict";angular.module("prokorm").run(function($rootScope){$rootScope._=window._})}(),function(){"use strict";angular.module("admin").controller("AdminController",function($state,$scope,adminFactory){var vm=this;vm.goToTenantInfo=function(_id){$state.go("admin.tenant",{tenant_id:_id})},adminFactory.getTenants().then(function(tenants){vm.tenants=tenants})})}(),angular.module("admin").factory("adminFactory",["$http","$location",function($http,$location){var adminFactory={getTenants:function(){return $http.get("/api/tenants")},getTenant:function(_id){return $http.get("/api/tenants/"+_id)}};return adminFactory}]),function(){"use strict";angular.module("admin").config(function($stateProvider,$urlRouterProvider){$stateProvider.state("admin",{url:"/admin",templateUrl:"app/admin/admin.html",controller:"AdminController",controllerAs:"admin",data:{module:"admin"}}).state("admin.tenant",{url:"/:tenant_id",templateUrl:"app/admin/tenant.html",controller:"TenantController",controllerAs:"tenant",params:{tenant_id:void 0},data:{module:"admin"}})})}(),function(){"use strict";angular.module("admin").controller("TenantController",function($scope,$stateParams,adminFactory){var vm=this;$stateParams.tenant_id&&adminFactory.getTenant($stateParams.tenant_id).then(function(tenant){vm.info=tenant})})}(),angular.module("auth").factory("authFactory",["$http","$location",function($http,$location){var authFactory={logout:function(){return $http.post("/api/logout/")},login:function(user){return $http.post("/api/signin/",user)},registration:function(user){return $http.post("/api/registration/",user)},getSessionData:function(){return $http.get("/api/sessionData/")},getProfileView:function(){return $http.get("/api/profile/view/")},getProfileEdit:function(){return $http.get("/api/profile/edit")},updateProfile:function(profile){return $http.put("/api/profile/",profile)},addUser:function(user){return $http.post("/api/users/",user)},setPassword:function(pass){return $http.post("/api/profile/password/",pass)},forgetPassword:function(pass){return $http.post("/api/forget/",pass)}};return authFactory}]),function(){"use strict";angular.module("auth").config(function($stateProvider,$urlRouterProvider){$stateProvider.state("registration",{url:"/registration",templateUrl:"app/auth/registration/registration.html",controller:"RegistrationController",controllerAs:"registration"}).state("login",{url:"/login",templateUrl:"app/auth/login/login.html",controller:"LoginController",controllerAs:"login"}).state("forget",{url:"/forget",templateUrl:"app/auth/forget/forget.html",controller:"ForgetController",controllerAs:"forget"}).state("login.tenant",{url:"/:tenant",templateUrl:"app/auth/login/login.html",controller:"LoginController",controllerAs:"login",params:{tenant:void 0}})})}(),function(){"use strict";angular.module("auth").controller("ForgetController",function(authFactory){var vm=this;vm.email="",vm.userName="",vm.tenantName="",vm.do=function(){authFactory.forgetPassword({email:vm.email}).then(function(result){vm.successMessage=result.message})}})}(),function(){"use strict";angular.module("auth").controller("LoginController",function($http,$state,authFactory){var vm=this;vm.tenantName=$state.params.tenant,vm.user={tenantname:vm.tenantName||"",username:"",password:""},vm.do=function(){authFactory.login(vm.user).then(function(response){$state.go("tenant.feed",{id:response.tenantName})},function(err){vm.info=err.message})}})}(),function(){"use strict";angular.module("auth").controller("RegistrationController",function($http,authFactory){var vm=this;vm.user={loginname:"",email:""},vm.do=function(){vm.error="",authFactory.registration(vm.user).then(function(response){response&&response.message&&(vm.successMessage=response.message)})},vm.goToRegistration=function(){}})}(),angular.module("catalog").factory("catalogFactory",["$http","$location",function($http,$location){var catalogFactory={getCatalog:function(){return $http.get("/api/catalog")},getCatalogContentByKey:function(key){return $http.get("/api/catalog/"+key)},saveCatalogContentByKey:function(catalog){return $http.put("/api/catalog/"+catalog.key,catalog)}};return catalogFactory}]),function(){"use strict";angular.module("catalog").config(function($stateProvider,$urlRouterProvider){$stateProvider.state("tenant.catalog",{url:"/catalog",templateUrl:"app/catalog/list/catalog.html",controller:"CatalogController",controllerAs:"catalog",data:{module:"catalog"}}).state("tenant.catalog.edit",{url:"/:terms/edit",templateUrl:"app/catalog/contentEdit/catalogContentEdit.html",controller:"CatalogContentEditController",controllerAs:"catalogContentEdit",params:{terms:void 0},data:{module:"catalog"}}).state("tenant.catalog.instance",{url:"/:terms",templateUrl:"app/catalog/content/catalogContent.html",controller:"CatalogContentController",controllerAs:"catalogContent",params:{terms:void 0},data:{module:"catalog"}})})}(),function(){"use strict";angular.module("catalog").controller("CatalogContentController",function($state,catalogFactory){var vm=this;if(vm.edit=function(){$state.go("tenant.catalog.edit",{terms:$state.params.terms})},!$state.params.terms)return;catalogFactory.getCatalogContentByKey($state.params.terms).then(function(catalogItem){vm.catalogItem=catalogItem})})}(),function(){"use strict";angular.module("catalog").controller("CatalogContentEditController",function($state,catalogFactory){var vm=this;if(vm.save=function(){catalogFactory.saveCatalogContentByKey(vm.catalogItem).then(function(catalogItem){$state.go("tenant.catalog.instance",{terms:$state.params.terms})})},!$state.params.terms)return;catalogFactory.getCatalogContentByKey($state.params.terms).then(function(catalogItem){vm.catalogItem=catalogItem})})}(),function(){"use strict";angular.module("catalog").controller("CatalogController",function($state,catalogFactory){var vm=this;vm.currentKey=$state.params.terms,catalogFactory.getCatalog().then(function(items){vm.catalogItems=items}),vm.onItemClick=function(catalogItem){vm.currentKey=catalogItem.key,$state.go("tenant.catalog.instance",{terms:catalogItem.key})}})}(),function(){"use strict";angular.module("feed").controller("AverageController",function($scope,$state,feedFactory,$stateParams,_){var vm=this;vm._=_;$stateParams.feeds;!function(feedsForAverage){if(!feedsForAverage.length)return vm.averageRows=[],vm.headers=[];feedFactory.averageFeeds(feedsForAverage).then(function(result){vm.dryRawValues=result.dryRawValues,vm.headers=result.headers,vm.analysisRows=result.analysis,vm.averageRows=result.average})}(_.filter($state.params.feeds.split(":"),Boolean))})}(),function(){"use strict";angular.module("feed").controller("AverageDemoController",function(feedFactory,_){var vm=this;vm.propertiesForDiff=[],vm._=_,feedFactory.averageDemoFeeds().then(function(result){vm.dryRawValues=result.dryRawValues,vm.headers=result.headers,vm.analysisRows=result.analysis,vm.averageRows=result.average})})}(),function(){"use strict";angular.module("feed").controller("ChartsController",function($scope,$state,feedFactory,$stateParams,_){var vm=this;vm.feeds=_.filter($state.params.feeds.split(":"),Boolean),function(){if(!vm.feeds||!vm.feeds.length)return;feedFactory.chartsFeeds(vm.feeds).then(function(data){Highcharts.chart("container",{legend:{itemStyle:{fontWeight:"500"},itemDistance:40,itemMarginBottom:10},chart:{type:"spline"},title:!1,plotOptions:{spline:{lineWidth:4,states:{hover:{lineWidth:5}},marker:{enabled:!1}}},xAxis:{categories:data.categories},yAxis:{title:!1},series:data.chartSeries})})}()})}(),function(){"use strict";angular.module("feed").controller("ChartsDemoController",function($scope,feedFactory,$stateParams,_){this.feeds=["fake"],feedFactory.chartsDemoFeeds().then(function(data){Highcharts.chart("container",{legend:{itemStyle:{fontWeight:"500"},itemDistance:40,itemMarginBottom:10},chart:{type:"spline"},title:!1,plotOptions:{spline:{lineWidth:4,states:{hover:{lineWidth:5}},marker:{enabled:!1}}},xAxis:{categories:data.categories},yAxis:{title:!1},series:data.chartSeries})})})}(),function(){function GroupButtonsController($scope){var self=this;$scope.items=self.items,$scope.$watchCollection("items.length",function(){console.log(self.items.length),self.selected=_.last(self.items),self.onSelect({item:self.selected})},!0),self.onClick=function(item){console.log(self.items.length),self.selected=item,self.onSelect({item:self.selected})}}angular.module("feed").directive("groupButtons",function(){return{restrict:"E",templateUrl:"app/feed/controls/groupButtons/groupButtons.html",scope:{items:"=",allowAdd:"=",onAdd:"&",onDelete:"&",onSelect:"&"},replace:!0,controller:GroupButtonsController,controllerAs:"groupButtons",bindToController:!0}})}(),function(){"use strict";angular.module("feed").controller("DiffController",function($scope,$state,feedFactory,$stateParams,_){var vm=this;vm._=_;$stateParams.feeds;!function(feedsForDiff){if(!feedsForDiff.length)return vm.diffRows=[],vm.headers=[];feedFactory.diffFeeds(feedsForDiff).then(function(result){vm.dryRawValues=result.dryRawValues,vm.headers=result.headers,vm.diffRows=result.diffs})}(_.filter($state.params.feeds.split(":"),Boolean))})}(),function(){"use strict";angular.module("feed").controller("DiffDemoController",function($scope,feedFactory,$stateParams,_){var vm=this;vm._=_,feedFactory.diffDemoFeeds().then(function(result){vm.dryRawValues=result.dryRawValues,vm.headers=result.headers,vm.diffRows=result.diffs})})}(),function(){"use strict";angular.module("feed").controller("FeedEditController",function($window,$stateParams,$state,$scope,feedFactory,FEED_TYPES,STORAGE_TYPES){var vm=this;vm.feedItem={analysis:[]},vm.feedTypes=FEED_TYPES,vm.storageTypes=STORAGE_TYPES,vm.feedItemControls=[];var feedId=$stateParams.feedId;(feedId?feedFactory.getFeedEdit(feedId):feedFactory.getEmptyFeed()).then(function(feed){vm.feedItemSections=feed,vm.feedItem.analysis=_.map(feed[0].subSections,function(subSection){return subSection.initialItem})}),vm.deleteCurrentAnalysis=function(){vm.feedItemSections[0].subSections=_.filter(vm.feedItemSections[0].subSections,function(sebSection){return sebSection.initialItem!==vm.currentAnalysis}),vm.feedItem.analysis=_.map(vm.feedItemSections[0].subSections,function(subSection){return subSection.initialItem})},vm.onAnalysisAdd=function(){feedFactory.getEmptyAnalysis().then(function(newAnalysis){if(vm.feedItem.analysis&&vm.feedItem.analysis.length){var max=_.max(_.map(vm.feedItem.analysis,"number"));newAnalysis.initialItem.number=max+1,vm.feedItem.analysis.push(newAnalysis)}vm.feedItemSections[0].subSections.push(newAnalysis),vm.feedItem.analysis=_.map(vm.feedItemSections[0].subSections,function(subSection){return subSection.initialItem})})},vm.onAnalysisSelect=function(item){vm.currentAnalysis=item},vm.save=function(){var feed={analysis:_.map(vm.feedItemSections[0].subSections,function(subSection){return subSection.initialItem}),general:vm.feedItemSections[1].subSections[0].initialItem,harvest:vm.feedItemSections[2].subSections[0].initialItem,feeding:vm.feedItemSections[3].subSections[0].initialItem};feedId&&(feed._id=feedId),feedFactory.saveFeed(feed).then(function(response){"OK"===response.message&&$state.go("tenant.feed.instance",{feedId:response.id})})},vm.cancel=function(){feedId?$state.go("tenant.feed.instance",{feedId:feedId}):$state.go("tenant.feed")},vm.onSelfExplanationLinkClick=function(key){$state.go("farm.help",{key:key})}})}(),angular.module("feed").factory("feedFactory",["$http","$location",function($http,$location){var urlBaseFeed="/api/feeds/",feedFactory={getFeeds:function(){return $http.get(urlBaseFeed)},getDemoFeeds:function(){return $http.get("/api/demoFeeds")},getFeedDashboard:function(){return $http.get("/api/feeds/dashboard")},getDemoFeedDashboard:function(){return $http.get("/api/feeds/demoDashboard")},saveFeed:function(feed){var methode=feed._id?"put":"post",url=feed._id?urlBaseFeed+feed._id:urlBaseFeed;return $http[methode](url,feed)},getFeedView:function(feedId){return $http.get(urlBaseFeed+feedId+"/view")},getFeedViewDemo:function(){return $http.get("/api/feeds/viewDemo")},getFeedEdit:function(feedId){return $http.get(urlBaseFeed+feedId+"/edit")},getEmptyFeed:function(){return $http.post("/api/feeds/new")},getEmptyAnalysis:function(){return $http.post("/api/feeds/newAnalysis")},deleteFeed:function(feedId){return $http.delete(urlBaseFeed+feedId)},diffFeeds:function(feedIds){return $http.post("/api/feeds/diff",{feedIds:feedIds})},diffDemoFeeds:function(feedIds){return $http.post("/api/feeds/diffDemo")},sumFeeds:function(feedIds){return $http.post("/api/feeds/sum",{feedIds:feedIds})},sumDemoFeeds:function(){return $http.post("/api/feeds/sumDemo")},planningFeeds:function(params){return $http.post("/api/feeds/planning",params)},planningDemoFeeds:function(params){return $http.post("/api/feeds/planningDemo")},averageFeeds:function(feedIds){return $http.post("/api/feeds/average",{feedIds:feedIds})},averageDemoFeeds:function(){return $http.post("/api/feeds/averageDemo")},chartsFeeds:function(feedIds){return $http.post("/api/feeds/charts",{feedIds:feedIds})},chartsDemoFeeds:function(feedIds){return $http.post("/api/feeds/chartsDemo")},ratingFeeds:function(feedIds,feedType){return $http.post("/api/feeds/rating",{feedIds:feedIds,feedType:feedType})},ratingDemoFeeds:function(){return $http.post("/api/feeds/ratingDemo")},searchFeeds:function(query){return $http.post("/api/feeds/search",{query:query})}};return feedFactory}]),function(){"use strict";angular.module("feed").constant("FEED_TYPES",[{value:"none",name:"Нет"},{value:"haylage",name:"Сенаж"},{value:"silage",name:"Силос"},{value:"grain",name:"Зерно"},{value:"cornSilage",name:"Силосованное зерно"},{value:"straw",name:"Солома"},{value:"hay",name:"Сено"},{value:"oilcake",name:"Жмых"},{value:"meal",name:"Шрот"},{value:"greenWeight",name:"Зеленая масса"},{value:"tmr",name:"TMR"}]),angular.module("feed").constant("STORAGE_TYPES",[{value:"silo",name:"Траншея"},{value:"mound",name:"Курган"},{value:"polymerSleeve",name:"Полимерный рукав"},{value:"polymerCoil",name:"Полимерный рулон"}])}(),function(){"use strict";angular.module("feed").config(function($stateProvider,$urlRouterProvider){$stateProvider.state("tenant.feed",{url:"/feed",templateUrl:"app/feed/list/feed.html",controller:"FeedController",controllerAs:"feed",data:{module:"feed"}}).state("tenant.feed.charts",{url:"/charts/:feeds",templateUrl:"app/feed/charts/charts.html",controller:"ChartsController",controllerAs:"charts",params:{feeds:void 0},data:{module:"feed"}}).state("tenant.feed.diff",{url:"/diff/:feeds",templateUrl:"app/feed/diff/diff.html",controller:"DiffController",controllerAs:"diff",params:{feeds:void 0},data:{module:"feed"}}).state("tenant.feed.sum",{url:"/sum/:feeds",templateUrl:"app/feed/sum/sum.html",controller:"SumController",controllerAs:"sum",params:{feeds:void 0},data:{module:"feed"}}).state("tenant.feed.average",{url:"/average/:feeds",templateUrl:"app/feed/average/average.html",controller:"AverageController",controllerAs:"average",params:{feeds:void 0},data:{module:"feed"}}).state("tenant.feed.rating",{url:"/rating",templateUrl:"app/feed/rating/rating.html",controller:"RatingController",controllerAs:"rating",params:{feeds:void 0},data:{module:"feed"}}).state("tenant.feed.planning",{url:"/planning/:feeds",templateUrl:"app/feed/planning/planning.html",controller:"PlanningController",controllerAs:"planning",params:{feeds:void 0},data:{module:"feed"}}).state("tenant.feed.rating.instance",{url:"/:feedType/:feeds",templateUrl:"app/feed/rating/ratingInstance.html",controller:"RatingController",controllerAs:"rating",params:{feedType:void 0,feeds:void 0},data:{module:"feed"}}).state("tenant.feed.new",{url:"/new",templateUrl:"app/feed/edit/feedEdit.html",controller:"FeedEditController",controllerAs:"feedEdit",data:{module:"feed"}}).state("tenant.feed.edit",{url:"/:feedId/edit",templateUrl:"app/feed/edit/feedEdit.html",controller:"FeedEditController",controllerAs:"feedEdit",params:{feedId:void 0},data:{module:"feed"}}).state("tenant.feed.instance",{url:"/:feedId",templateUrl:"app/feed/view/feedView.html",controller:"FeedViewController",controllerAs:"feedView",params:{feedId:void 0},data:{module:"feed"}})})}(),function(){"use strict";angular.module("feed").controller("FeedController",function($scope,$window,$state,feedFactory,$mdDialog){var vm=this;vm.filter={noAnalysis:!0,showEmpty:!0},feedFactory.getFeeds().then(function(result){vm.filterValues=result.filterValues,vm.feedItems=result.feeds,vm.selectedItemId=$state.params.feedId,vm.updateVisible()}),feedFactory.getFeedDashboard().then(function(dashboard){vm.dashboard=dashboard}),vm.openMenu=function($mdOpenMenu,ev){$mdOpenMenu(ev)},vm.goToHome=function(){vm.selectedItemId=null,$state.go("tenant.feed")},vm.addFeed=function(){$state.go("tenant.feed.new")},vm.diffFeed=function(){$state.go("tenant.feed.diff")},vm.averageFeed=function(){$state.go("tenant.feed.average")},vm.sumFeed=function(){$state.go("tenant.feed.sum")},vm.planningFeed=function(){$state.go("tenant.feed.planning")},vm.chartsFeed=function(){$state.go("tenant.feed.charts")},vm.ratingFeed=function(){$state.go("tenant.feed.rating")},vm.isDisabled=function(feedItem){return vm.isDiffMode||vm.isAverageMode||vm.isChartMode||vm.isRatingMode?!Boolean(feedItem.analysis):!!vm.isSumMode&&(!Boolean(feedItem.analysis)||!Boolean(feedItem.balanceWeight))},vm.filterByMode=!1,vm.clearFilter=function(){vm.filter={noAnalysis:!0,showEmpty:!0},vm.updateVisible()},vm.toggleFilter=function(){vm.filterByMode=!1,vm.filter.visible&&($state.go(vm.lastState,{feeds:[]}),vm.updateVisible()),vm.filter.visible=!vm.filter.visible},vm.updateVisible=function(){_.forEach(vm.feedItems,function(feed){feed.isVisible=function(feedItem){if(vm.filter){if(!vm.filter.showEmpty&&feedItem.done)return!1;if(!vm.filter.noAnalysis&&!feedItem.analysis)return!1;if(vm.filter.years&&vm.filter.years.length&&vm.filter.years.indexOf(feedItem.year)<0)return!1;if(vm.filter.feedTypes&&vm.filter.feedTypes.length&&vm.filter.feedTypes.indexOf(feedItem.feedType)<0)return!1;if(vm.filter.compositions&&vm.filter.compositions.length&&vm.filter.compositions.indexOf(feedItem.composition)<0)return!1;if(vm.filter.branches&&vm.filter.branches.length&&vm.filter.branches.indexOf(feedItem.branch)<0)return!1;if(vm.filter.storages&&vm.filter.storages.length&&vm.filter.storages.indexOf(feedItem.storage)<0)return!1}{if(vm.isDiffMode&&!feedItem.analysis)return!1;if(vm.isAverageMode&&!feedItem.analysis)return!1;if(!(!vm.isSumMode||feedItem.analysis&&feedItem.balanceWeight))return!1;if(!(!vm.isPlanningMode||feedItem.analysis&&feedItem.balanceWeight))return!1;if(vm.isChartMode&&!feedItem.analysis)return!1;if(vm.isRatingMode&&!feedItem.analysis)return!1}return!0}(feed)}),vm.hiddenItemsLength=_.size(_.filter(vm.feedItems,{isVisible:!1}))},vm.selectAll=function(){var ids=_.map(_.filter(vm.feedItems,function(feed){return feed.isVisible&&!vm.isDisabled(feed)}),"_id");$state.go(vm.lastState,{feeds:ids.join(":")})},vm.onFeedClick=function(feedItem){if(vm.isDiffMode||vm.isAverageMode||vm.isSumMode||vm.isPlanningMode||vm.isChartMode||vm.isRatingMode){var currentFeeds=_.filter($state.params.feeds.split(":"),function(o){return o}),ind=currentFeeds.indexOf(feedItem._id);-1<ind?currentFeeds.splice(ind,1):currentFeeds.push(feedItem._id),$state.go(vm.lastState,{feeds:currentFeeds.join(":")})}else vm.selectedItemId=feedItem._id,$state.go("tenant.feed.instance",{feedId:feedItem._id})},$scope.$on("stateChangeStart",function(oldState,newState){}),$scope.$on("$stateChangeSuccess",function(event,newState,params,oldState){vm.lastState=newState.name,vm.isDiffMode="tenant.feed.diff"===newState.name,vm.isAverageMode="tenant.feed.average"===newState.name,vm.isSumMode="tenant.feed.sum"===newState.name,vm.isPlanningMode="tenant.feed.planning"===newState.name,vm.isChartMode="tenant.feed.charts"===newState.name,vm.isRatingMode="tenant.feed.rating.instance"===newState.name,vm.selectedItemId=null,vm.diffFeeds=null,vm.averageFeeds=null,vm.sumFeeds=null,vm.planningFeeds=null,vm.chartFeeds=null,vm.ratingFeeds=null;var paramFeeds=params.feeds?params.feeds.split(":"):[];vm.isDiffMode?(vm.selectedItemId=null,vm.diffFeeds=paramFeeds):vm.isAverageMode?(vm.selectedItemId=null,vm.averageFeeds=paramFeeds):vm.isSumMode?(vm.selectedItemId=null,vm.sumFeeds=paramFeeds):vm.isPlanningMode?(vm.selectedItemId=null,vm.planningFeeds=paramFeeds):vm.isChartMode?(vm.selectedItemId=null,vm.chartFeeds=paramFeeds):vm.isRatingMode?(vm.selectedItemId=null,vm.ratingFeeds=paramFeeds):"tenant.feed"===newState.name?(vm.selectedItemId=null,feedFactory.getFeedDashboard().then(function(dashboard){vm.dashboard=dashboard})):"tenant.feed.instance"===newState.name&&(vm.selectedItemId=params.feedId),"tenant.feed.edit"===oldState.name||"tenant.feed.new"===oldState.name||"tenant.feed"===newState.name?feedFactory.getFeeds().then(function(result){vm.feedItems=result.feeds,vm.filterValues=result.filterValues,vm.updateVisible(),vm.filterByMode=!0}):vm.updateVisible()})})}(),function(){"use strict";angular.module("feed").controller("FeedDemoController",function($scope,$window,$state,feedFactory,$mdDialog){var vm=this;vm.filter={noAnalysis:!0,showEmpty:!0},feedFactory.getDemoFeeds().then(function(result){vm.feedItems=result.feeds}),feedFactory.getDemoFeedDashboard().then(function(dashboard){vm.dashboard=dashboard})})}(),function(){"use strict";angular.module("feed").factory("tonnPerDay",function(FEED_TYPES,_){var result={};return _.forEach(FEED_TYPES,function(feedType){result[feedType.value]=0}),result}),angular.module("feed").controller("PlanningController",function($scope,$state,feedFactory,$stateParams,tonnPerDay,_){var vm=this;vm._=_,vm.tonnPerDay=tonnPerDay;var t,params={feedIds:[],tonnPerDay:vm.tonnPerDay};$stateParams.feeds;vm.onChange=function(){t&&clearTimeout(t),t=setTimeout(function(){feedFactory.planningFeeds(params).then(function(result){vm.properties=result.properties,vm.rows=result.sumsRows})},1e3)},function(feeds){if(!feeds.length)return vm.diffRows=[],vm.headers=[];params.feedIds=feeds,feedFactory.planningFeeds(params).then(function(result){vm.properties=result.properties,vm.rows=result.sumsRows})}(_.filter($state.params.feeds.split(":"),Boolean))})}(),function(){"use strict";angular.module("feed").controller("PlanningDemoController",function($scope,$state,feedFactory,$stateParams,tonnPerDay,_){var vm=this;vm._=_,vm.tonnPerDay=tonnPerDay,vm.demoMode=!0,feedFactory.planningDemoFeeds().then(function(result){vm.properties=result.properties,vm.rows=result.sumsRows,vm.tonnPerDay.haylage=32})})}(),function(){"use strict";angular.module("feed").controller("RatingController",function($scope,$state,feedFactory,$stateParams,_){var vm=this,allProps={haylage:["Сухое вещество","Баланс расщепляемого протеина, OEB","Переваримость органического вещества, VCOS","NH3-фракция","Сахар","Нейтрально-детергентная клетчатка, NDF","Сырой протеин"],greenmass:["Сырая зола","Баланс расщепляемого протеина, OEB","Переваримость органического вещества, VCOS","Сахар","Нейтрально-детергентная клетчатка, NDF","Сырой протеин"],silage:["Сухое вещество","Чистая энергия на лактацию, NEL","Переваримость органического вещества, VCOS","NH3-фракция","Крахмал","Нейтрально-детергентная клетчатка, NDF"]},allLabels={haylage:"Травяной сенаж",greenmass:"Зеленая масса",silage:"Кукурузный силос"};vm.feedType=$state.params.feedType,vm.goToHaylage=function(){$state.go("tenant.feed.rating.instance",{feedType:"haylage"})},vm.goToSilage=function(){$state.go("tenant.feed.rating.instance",{feedType:"silage"})},vm.goToGreenMass=function(){$state.go("tenant.feed.rating.instance",{feedType:"greenmass"})},$scope.$on("$stateChangeSuccess",function(event,newState,params,oldState){vm.props=allProps[params.feedType],vm.feedTypeLabel=allLabels[params.feedType],"tenant.feed.rating.instance"===newState.name&&params.feeds&&params.feeds.length&&function(feeds){if(!feeds.length)return vm.feeds=[],vm.properties=[];feedFactory.ratingFeeds(feeds,vm.feedType).then(function(result){vm.properties=result.properties,vm.feeds=result.feeds})}(_.filter(params.feeds.split(":"),Boolean))})})}(),function(){"use strict";angular.module("feed").controller("RatingDemoController",function($scope,feedFactory,$state,$stateParams,_){var vm=this;feedFactory.ratingDemoFeeds().then(function(result){vm.properties=result.properties,vm.feeds=result.feeds})})}(),function(){"use strict";angular.module("feed").controller("SumController",function($scope,$state,feedFactory,$stateParams,_){var vm=this;vm._=_;$stateParams.feeds;!function(feedsForDiff){if(!feedsForDiff.length)return vm.diffRows=[],vm.headers=[];feedFactory.sumFeeds(feedsForDiff).then(function(result){vm.properties=result.properties,vm.sumsRows=result.sumsRows})}(_.filter($state.params.feeds.split(":"),Boolean))})}(),function(){"use strict";angular.module("feed").controller("SumDemoController",function(feedFactory,_){var vm=this;vm._=_,feedFactory.sumDemoFeeds().then(function(result){vm.properties=result.properties,vm.sumsRows=result.sumsRows})})}(),function(){"use strict";function FeedViewController($mdDialog,$stateParams,$state,authFactory,feedFactory,_){var vm=this;vm._=_;var feedId=$stateParams.feedId;feedId&&(vm.isDrySwitch=!0,vm.print=function(){authFactory.getSessionData().then(function(data){var analysisPrint=document.getElementById("analysis"),generalPrint=document.getElementById("general"),harvestPrint=document.getElementById("harvest"),feedingPrint=document.getElementById("feeding"),popupWin=window.open("","_blank");popupWin.document.open(),popupWin.document.write('<html style="background-color: #fff;"><title>AGRODESK:печать</title><head><link rel="stylesheet" type="text/css" href="app.css"/><link rel="stylesheet" type="text/css" href="libs.css"/></head><body onload="setTimeout(function() {window.print(); window.close();}, 500)" class="feed print">'+(analysisPrint?'<div class="print-title"><h2>'+data.user.tenantFullName+'</h2><label class="key">анализы:  </label>'+vm.feed.name+"&nbsp;&nbsp;&nbsp;"+vm.feed.year+"&nbsp;&nbsp;&nbsp;"+vm.feed.storage+"</div><br/>"+analysisPrint.innerHTML+'<div class="break"></div>':"")+(generalPrint?'<div class="print-title"><h2>'+data.user.tenantFullName+'</h2><label class="key">основные:  </label>'+vm.feed.name+"   "+vm.feed.year+"</div><br/>"+generalPrint.innerHTML+"<br/>":"")+(harvestPrint?'<div class="print-title"><h2>'+data.user.tenantFullName+'</h2><label class="key">заготовка:  </label>'+vm.feed.name+"   "+vm.feed.year+"</div><br/>"+harvestPrint.innerHTML+"<br/>":"")+(feedingPrint?'<div class="print-title"><h2>'+data.user.tenantFullName+'</h2><label class="key">кормление:  </label>'+vm.feed.name+"   "+vm.feed.year+"</div><br/>"+feedingPrint.innerHTML:"")+"</body><footer>prokorm.com</footer></html>"),popupWin.document.close()})},vm.edit=function(){$state.go("tenant.feed.edit",{feedId:feedId})},vm.delete=function(ev){var confirm=$mdDialog.confirm().title("Удаление").textContent("Вы хотите удалить корм "+vm.feed.name+" ?").targetEvent(ev).ok("Да").cancel("Отменить");$mdDialog.show(confirm).then(function(){feedFactory.deleteFeed($stateParams.feedId).then(function(res){$state.go("tenant.feed")})},function(){})},feedFactory.getFeedView(feedId).then(function(feedView){vm.feed=feedView.general,vm.feedItemSections=feedView.feedItemSections,vm.actions=feedView.actions}))}FeedViewController.$inject=["$mdDialog","$stateParams","$state","authFactory","feedFactory","_"],angular.module("feed").controller("FeedViewController",FeedViewController)}(),function(){"use strict";function FeedViewDemoController($stateParams,$state,feedFactory,_){var vm=this;vm._=_,vm.isDrySwitch=!0,vm.print=function(){authFactory.getSessionData().then(function(data){var analysisPrint=document.getElementById("analysis"),generalPrint=document.getElementById("general"),harvestPrint=document.getElementById("harvest"),feedingPrint=document.getElementById("feeding"),popupWin=window.open("","_blank");popupWin.document.open(),popupWin.document.write('<html style="background-color: #fff;"><title><b>AGRO</b>DESK:печать</title><head><link rel="stylesheet" type="text/css" href="app.css"/><link rel="stylesheet" type="text/css" href="libs.css"/></head><body onload="setTimeout(function() {window.print(); window.close();}, 500)" class="feed print">'+(analysisPrint?'<div class="print-title"><h2>'+data.user.tenantFullName+'</h2><label class="key">анализы:  </label>'+vm.feed.name+"&nbsp;&nbsp;&nbsp;"+vm.feed.year+"&nbsp;&nbsp;&nbsp;"+vm.feed.storage+"</div><br/>"+analysisPrint.innerHTML+'<div class="break"></div>':"")+(generalPrint?'<div class="print-title"><h2>'+data.user.tenantFullName+'</h2><label class="key">основные:  </label>'+vm.feed.name+"   "+vm.feed.year+"</div><br/>"+generalPrint.innerHTML+"<br/>":"")+(harvestPrint?'<div class="print-title"><h2>'+data.user.tenantFullName+'</h2><label class="key">заготовка:  </label>'+vm.feed.name+"   "+vm.feed.year+"</div><br/>"+harvestPrint.innerHTML+"<br/>":"")+(feedingPrint?'<div class="print-title"><h2>'+data.user.tenantFullName+'</h2><label class="key">кормление:  </label>'+vm.feed.name+"   "+vm.feed.year+"</div><br/>"+feedingPrint.innerHTML:"")+"</body><footer>prokorm.com</footer></html>"),popupWin.document.close()})},feedFactory.getFeedViewDemo().then(function(feedView){vm.feed=feedView.general,vm.feedItemSections=feedView.feedItemSections,vm.actions=feedView.actions})}FeedViewDemoController.$inject=["$stateParams","$state","feedFactory","_"],angular.module("feed").controller("FeedViewDemoController",FeedViewDemoController)}(),function(){"use strict";angular.module("help").controller("HelpController",function($scope,$state){})}(),function(){"use strict";angular.module("help").config(function($stateProvider,$urlRouterProvider){$stateProvider.state("tenant.help",{url:"/help",templateUrl:"app/help/help.html",controller:"HelpController",controllerAs:"help",data:{module:"help"}})})}(),function(){"use strict";angular.module("prokorm").controller("HomeController",function($scope,$state,authFactory,$mdDialog){var vm=this;vm.currentModule="",authFactory.getSessionData().then(function(data){vm.sessionData=data}),vm.openMenu=function($mdOpenMenu,ev){$mdOpenMenu(ev)},vm.goToModule=function(module){$state.go("tenant."+module)},vm.logout=function(){authFactory.logout()},vm.profile=function(){$state.go("tenant.profile.view")},vm.help=function(){$state.go("tenant.help")},vm.info=function(){$state.go("tenant.info")},$scope.$on("$stateChangeSuccess",function(event,newState,params,oldState){vm.currentModule=newState.data&&newState.data.module})})}(),function(){"use strict";angular.module("info").controller("InfoController",function($scope,$state,version){this.version=version})}(),function(){"use strict";angular.module("info").config(function($stateProvider,$urlRouterProvider){$stateProvider.state("tenant.info",{url:"/info",templateUrl:"app/info/info.html",controller:"InfoController",controllerAs:"info",data:{module:"info"}})})}(),function(){"use strict";function ChangePasswordController($scope,$state,$mdDialog,authFactory){$scope.currentPassword="",$scope.newPassword="",$scope.newPassword2="",$scope.cancel=function(){$mdDialog.cancel()},$scope.save=function(){$scope.error=null,authFactory.setPassword({currentPassword:$scope.currentPassword,newPassword:$scope.newPassword,newPassword2:$scope.newPassword2}).then(function(data){"OK"===data.message?$mdDialog.show($mdDialog.alert().clickOutsideToClose(!1).title("Смена пароля").textContent("Новый пароль сохранен").ok("Ok")):$scope.error=data.message},function(){return!1})}}angular.module("prokorm").controller("ProfileViewController",function($scope,$state,$mdDialog,authFactory){var vm=this;authFactory.getProfileView().then(function(result){vm.userInfo=result.userInfo,vm.companyUsers=result.companyUsers,vm.companyLicense=result.companyLicense,vm.admin=result.admin}),vm.edit=function(){$state.go("tenant.profile.edit")},vm.changePassword=function(ev){ev.stopPropagation(),ev.preventDefault(),$mdDialog.show({controller:ChangePasswordController,templateUrl:"./app/profile/changePassword/changePassword.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1,escapeToClose:!1,backdrop:"static"})},vm.addUser=function(){$state.go("tenant.profile.addUser")}}),angular.module("prokorm").controller("ProfileEditController",function($scope,$state,authFactory){var vm=this;authFactory.getProfileEdit().then(function(result){vm.userInfo=result.controls,vm.profile=result.profile}),vm.save=function(){authFactory.updateProfile(vm.profile).then(function(result){"OK"===result.message&&$state.go("tenant.profile.view")})},vm.cancel=function(){$state.go("tenant.profile.view")}}),angular.module("prokorm").controller("AddUserController",function($scope,$state,authFactory){var vm=this;vm.user={name:"",fullName:"",email:"",password:"",tenantFullName:""},vm.cancel=function(){$state.go("tenant.profile.view")},vm.save2=function(){if(vm.user.password===vm.password_2){var permissions=[];vm.allowRead&&permissions.push("read"),vm.allowWrite&&permissions.push("write");var user=_.extend(vm.user,{permissions:permissions});authFactory.addUser(user).then(function(result){"OK"===result.message&&$state.go("tenant.profile.view")})}}}),angular.module("prokorm").controller("ChangePasswordController",ChangePasswordController)}(),function(){"use strict";angular.module("profile").config(function($stateProvider,$urlRouterProvider){$stateProvider.state("tenant.profile",{url:"/profile",templateUrl:"app/profile/profileRoot/profile.html",abstract:!0}).state("tenant.profile.view",{url:"/view",templateUrl:"app/profile/profileView/profileView.html",controller:"ProfileViewController",controllerAs:"profileView",data:{module:"profile"}}).state("tenant.profile.addUser",{url:"/addUser",templateUrl:"app/profile/addUser/addUser.html",controller:"AddUserController",controllerAs:"addUser",data:{module:"profile"}}).state("tenant.profile.edit",{url:"/edit",templateUrl:"app/profile/profileEdit/profileEdit.html",controller:"ProfileEditController",controllerAs:"profileEdit",data:{module:"profile"}})})}(),function(){"use strict";function ChangePasswordController($scope,$mdDialog,authFactory){$scope.currentPassword="",$scope.newPassword="",$scope.newPassword2="",$scope.cancel=function(){$mdDialog.cancel()},$scope.save=function(){authFactory.setPassword({currentPassword:$scope.currentPassword,newPassword:$scope.newPassword,newPassword2:$scope.newPassword2}).then(function(data){"OK"===data.message&&$state.go("tenant.profile.view")})}}angular.module("profile").controller("ProfileViewController",function($scope,$state,$mdDialog,authFactory){var vm=this;authFactory.getProfileView().then(function(result){vm.userInfo=result.controls,vm.companyUsers=result.companyUsers}),vm.edit=function(){$state.go("tenant.profile.edit")},vm.changePassword=function(ev){$mdDialog.show({controller:ChangePasswordController,templateUrl:"./app/profile/changePassword/changePassword.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!1}).then(function(answer){$state.go("tenant.profile.view")},function(){$state.go("tenant.profile.view")})},vm.addUser=function(){$state.go("tenant.profile.addUser")}}),angular.module("profile").controller("ProfileEditController",function($scope,$state,authFactory){var vm=this;authFactory.getProfileEdit().then(function(result){vm.userInfo=result.controls,vm.profile=result.profile}),vm.save=function(){authFactory.updateProfile(vm.profile).then(function(result){"OK"===result.message&&$state.go("tenant.profile.view")})},vm.cancel=function(){$state.go("tenant.profile.view")}}),angular.module("profile").controller("AddUserController",function($scope,$state,authFactory){var vm=this;vm.user={name:"",fullName:"",email:"",password:"",tenantFullName:""},vm.cancel=function(){$state.go("tenant.profile.view")},vm.save2=function(){if(vm.user.password===vm.password_2){var permissions=[];vm.allowRead&&permissions.push("read"),vm.allowWrite&&permissions.push("write");var user=_.extend(vm.user,{permissions:permissions});authFactory.addUser(user).then(function(result){"OK"===result.message&&$state.go("tenant.profile.view")})}}}),angular.module("profile").controller("ChangePasswordController",ChangePasswordController)}(),function(){"use strict";angular.module("prokorm").controller("PublicController",function($state,authFactory){"public"===$state.current.name?($state.go("public.list"),this.current="list"):this.current=$state.current.name.split(".")[1];this.buttons=[{name:"список",key:"list",url:"/#/list"},{name:"анализы",key:"view",url:"/#/view"},{name:"сравнение",key:"diff",url:"/#/diff"},{name:"среднее",key:"average",url:"/#/average"},{name:"сумма",key:"sum",url:"/#/sum"},{name:"планирование",key:"planning",url:"/#/planning"},{name:"рейтинг",key:"rating",url:"/#/rating"},{name:"аналитика",key:"charts",url:"/#/charts"}]})}(),function(){"use strict";function RationEditController($mdDialog,$stateParams,$state,$scope,feedFactory,rationFactory,_){var vm=this;vm.totalWeight=0,vm.totalDryWeight=0,vm.totalPrice=0;var rationId=$stateParams.rationId;(rationId?rationFactory.getRationEdit(rationId):rationFactory.getEmptyRation()).then(function(ration){vm.ration=ration}),vm.querySearch=function(query){return feedFactory.searchFeeds(query)},vm.searchTextChange=function(){},vm.addFeed=function(){vm.ration[1].body.push([vm.ration[1].body.length+1,"",0,0,0,0,0])}}RationEditController.$inject=["$mdDialog","$stateParams","$state","$scope","feedFactory","rationFactory","_"],angular.module("ration").controller("RationEditController",RationEditController)}(),function(){"use strict";angular.module("ration").controller("RationController",function($scope,$window,$state,rationFactory,$mdDialog){this.rationItems=[{type:"раздой",target:"32 литра",name:"20-100 дней, двор 620-100 дней, двор 6",description:"",targetCow:{group:"Раздой 20-100",weight:600},start:"12 Apr 2016",end:"",inProgress:!0},{type:"сухостой",target:"12 литров",name:"200-260 дней, двор 4",description:"",targetCow:{group:"Раздой 20-100",weight:600},start:"12 Nov 2016",end:"",inProgress:!0}],this.onRationClick=function(feedItem){}})}(),angular.module("ration").factory("rationFactory",["$http","$location",function($http,$location){var rationFactory={getRations:function(){return $http.get("/api/rations/")},getRationDashboard:function(){return $http.get("/api/rations/dashboard")},saveRation:function(ration){var methode=ration._id?"put":"post",url=ration._id?"/api/rations/"+ration._id:"/api/rations/";return $http[methode](url,ration)},getEmptyRation:function(){return $http.post("/api/rations/new")}};return rationFactory}]),function(){"use strict";angular.module("ration").config(function($stateProvider,$urlRouterProvider){$stateProvider.state("tenant.ration",{url:"/ration",templateUrl:"app/ration/list/ration.html",controller:"RationController",controllerAs:"ration",data:{module:"ration"}}).state("tenant.ration.new",{url:"/new",templateUrl:"app/ration/edit/rationEdit.html",controller:"RationEditController",controllerAs:"rationEdit",data:{module:"ration"}}).state("tenant.ration.edit",{url:"/:rationId/edit",templateUrl:"app/ration/edit/rationEdit.html",controller:"RationEditController",controllerAs:"rationEdit",params:{rationId:void 0},data:{module:"ration"}}).state("tenant.ration.instance",{url:"/:rationId",templateUrl:"app/ration/view/rationView.html",controller:"RationViewController",controllerAs:"rationView",params:{rationId:void 0},data:{module:"ration"}})})}(),function(){"use strict";function RationViewController($mdDialog,$stateParams,$state,authFactory,feedFactory,_){}RationViewController.$inject=["$mdDialog","$stateParams","$state","authFactory","feedFactory","_"],angular.module("ration").controller("RationViewController",RationViewController)}(),function(){"use strict";angular.module("prokorm").controller("SanoController",function($scope,$state,$mdDialog){})}();